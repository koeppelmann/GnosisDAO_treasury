name: Update Treasury Data

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Zerion data
        env:
          ZERION_API_KEY: ${{ secrets.ZERION_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import base64
          import time
          import os

          API_KEY = os.environ['ZERION_API_KEY']
          BASE_URL = "https://api.zerion.io/v1"
          CHAIN_IDS = "ethereum,xdai"

          ACCOUNTS = [
              "0x849D52316331967b6fF1198e5E32A0eB168D039d",
              "0xa5C629E04E563355c30885B62928fd6E03558548",
              "0x15a954001BB47890a4c46A7FE9f06F7c39fF3D68",
              "0x458cD345B4C05e8DF39d0A07220feb4Ec19F5e6f",
              "0x6bbe78ee9e474842dbd4ab4987b3cefe88426a92",
              "0xCdF50be9061086e2eCfE6e4a1BF9164d43568EEC",
              "0x9065A0F9545817d18b58436771b4d87Bda8f008B",
              "0x509Ad7278A2F6530Bc24590C83E93fAF8fd46E99",
              "0x0DA0C3e52C977Ed3cBc641fF02DD271c3ED55aFe",
              "0x2923c1B5313F7375fdaeE80b7745106deBC1b53E",
              "0x7eEa4286E9e82ba332F49400D037609BB1Cf70DA",
              "0x45a09fabD540b54f499212B3f579f0cF3393Ab6b",
              "0x0668792caF78D5bad6cD0B8EcE032dFA7C11aC60",
              "0x823A92aB789b15B88F43d798c332d6F38a32f0f6",
              "0x93EbF01356f44A1b0734081b0440bFf7bAcf72Ec",
              "0x399948eee21c5627Adb7De4A7EFe712245D48442",
              "0x4971DD016127F390a3EF6b956Ff944d0E2e1e462",
              "0x10E4597fF93cbee194F4879f8f1d54a370DB6969",
              "0x5BE8aB1c28ee22Cdf9B136FEDa7D8f20876Bfc0F",
              "0x689d4bd36bc1938Af5cA2673c3c753235e3b4D2b",
              "0x813804d2D0820a6D8139946229BB840591bAEB47",
              "0x2Bd0563e3e2C55edDaBe4E469a02cA6652fB9e4A"
          ]

          def get_auth_headers():
              auth_str = f"{API_KEY}:"
              b64_auth = base64.b64encode(auth_str.encode()).decode()
              return {"Authorization": f"Basic {b64_auth}", "Accept": "application/json"}

          def get_all_positions(address, headers):
              url = f"{BASE_URL}/wallets/{address}/positions"
              params = {"filter[chain_ids]": CHAIN_IDS, "filter[positions]": "no_filter", "currency": "usd", "page[size]": 100}
              all_positions = []
              while url:
                  try:
                      response = requests.get(url, headers=headers, params=params)
                      if response.status_code == 429:
                          time.sleep(2)
                          continue
                      response.raise_for_status()
                      data = response.json()
                      all_positions.extend(data.get('data', []))
                      url = data.get('links', {}).get('next')
                      params = None
                  except Exception as e:
                      print(f"Error: {e}")
                      break
              return all_positions

          headers = get_auth_headers()
          results = {}
          for i, account in enumerate(ACCOUNTS):
              print(f"[{i+1}/{len(ACCOUNTS)}] {account}")
              results[account] = get_all_positions(account, headers)
              time.sleep(0.5)

          with open("zerion_gnosis_dao_positions.json", "w") as f:
              json.dump(results, f, indent=2)
          print("Saved zerion_gnosis_dao_positions.json")
          EOF

      - name: Fetch DeBank data
        env:
          DEBANK_API_KEY: ${{ secrets.DEBANK_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os

          ACCESS_KEY = os.environ['DEBANK_API_KEY']
          BASE_URL = "https://pro-openapi.debank.com/v1"
          CHAIN_IDS = "eth,xdai"

          ACCOUNTS = [
              "0x849D52316331967b6fF1198e5E32A0eB168D039d",
              "0xa5C629E04E563355c30885B62928fd6E03558548",
              "0x15a954001BB47890a4c46A7FE9f06F7c39fF3D68",
              "0x458cD345B4C05e8DF39d0A07220feb4Ec19F5e6f",
              "0x6bbe78ee9e474842dbd4ab4987b3cefe88426a92",
              "0xCdF50be9061086e2eCfE6e4a1BF9164d43568EEC",
              "0x9065A0F9545817d18b58436771b4d87Bda8f008B",
              "0x509Ad7278A2F6530Bc24590C83E93fAF8fd46E99",
              "0x0DA0C3e52C977Ed3cBc641fF02DD271c3ED55aFe",
              "0x2923c1B5313F7375fdaeE80b7745106deBC1b53E",
              "0x7eEa4286E9e82ba332F49400D037609BB1Cf70DA",
              "0x45a09fabD540b54f499212B3f579f0cF3393Ab6b",
              "0x0668792caF78D5bad6cD0B8EcE032dFA7C11aC60",
              "0x823A92aB789b15B88F43d798c332d6F38a32f0f6",
              "0x93EbF01356f44A1b0734081b0440bFf7bAcf72Ec",
              "0x399948eee21c5627Adb7De4A7EFe712245D48442",
              "0x4971DD016127F390a3EF6b956Ff944d0E2e1e462",
              "0x10E4597fF93cbee194F4879f8f1d54a370DB6969",
              "0x5BE8aB1c28ee22Cdf9B136FEDa7D8f20876Bfc0F",
              "0x689d4bd36bc1938Af5cA2673c3c753235e3b4D2b",
              "0x813804d2D0820a6D8139946229BB840591bAEB47",
              "0x2Bd0563e3e2C55edDaBe4E469a02cA6652fB9e4A"
          ]

          headers = {'AccessKey': ACCESS_KEY, 'accept': 'application/json'}

          def get_tokens(address):
              try:
                  r = requests.get(f"{BASE_URL}/user/all_token_list", params={'id': address, 'chain_ids': CHAIN_IDS, 'is_all': 'true'}, headers=headers)
                  r.raise_for_status()
                  return r.json()
              except Exception as e:
                  print(f"Error: {e}")
                  return []

          def get_protocols(address):
              try:
                  r = requests.get(f"{BASE_URL}/user/all_complex_protocol_list", params={'id': address, 'chain_ids': CHAIN_IDS}, headers=headers)
                  r.raise_for_status()
                  return r.json()
              except Exception as e:
                  print(f"Error: {e}")
                  return []

          all_data = {}
          for i, account in enumerate(ACCOUNTS):
              print(f"[{i+1}/{len(ACCOUNTS)}] {account}")
              all_data[account] = {"tokens": get_tokens(account), "protocols": get_protocols(account)}

          with open("debank_balances_positions.json", "w") as f:
              json.dump(all_data, f, indent=2)
          print("Saved debank_balances_positions.json")
          EOF

      - name: Fetch Ltd. GNO balance
        env:
          ZERION_API_KEY: ${{ secrets.ZERION_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import base64
          import os
          from datetime import datetime

          API_KEY = os.environ['ZERION_API_KEY']
          LTD_ADDRESS = '0x604e4557e9020841f4e8eb98148de3d3cdea350c'

          auth = base64.b64encode(f"{API_KEY}:".encode()).decode()
          headers = {'Authorization': f'Basic {auth}', 'Accept': 'application/json'}

          response = requests.get(
              f"https://api.zerion.io/v1/wallets/{LTD_ADDRESS}/positions",
              headers=headers,
              params={'filter[chain_ids]': 'ethereum,xdai', 'currency': 'usd'}
          )
          response.raise_for_status()
          data = response.json()

          gno_quantity = sum(
              p.get('attributes', {}).get('quantity', {}).get('float', 0)
              for p in data.get('data', [])
              if (p.get('attributes', {}).get('fungible_info', {}).get('symbol') or '').upper() == 'GNO'
          )

          result = {
              'address': LTD_ADDRESS,
              'gno_balance': gno_quantity,
              'fetched_at': datetime.now().isoformat()
          }

          with open('ltd_gno_balance.json', 'w') as f:
              json.dump(result, f, indent=2)
          print(f"Saved Ltd. GNO balance: {gno_quantity:,.2f} GNO")
          EOF

      - name: Create metadata file
        run: |
          echo "{\"fetched_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > data_metadata.json

      - name: Archive snapshot and generate summary
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime

          TODAY = datetime.utcnow().strftime('%Y-%m-%d')
          ARCHIVE_DIR = f"archive/{TODAY}"
          os.makedirs(ARCHIVE_DIR, exist_ok=True)

          # Load current data
          with open('zerion_gnosis_dao_positions.json') as f:
              zerion_data = json.load(f)
          with open('debank_balances_positions.json') as f:
              debank_data = json.load(f)
          with open('ltd_gno_balance.json') as f:
              ltd_data = json.load(f)

          # Copy raw data to archive
          with open(f'{ARCHIVE_DIR}/zerion.json', 'w') as f:
              json.dump(zerion_data, f)
          with open(f'{ARCHIVE_DIR}/debank.json', 'w') as f:
              json.dump(debank_data, f)

          # Calculate summary
          SYMBOL_NORMALIZATION = {
              'WETH': 'ETH', 'WSTETH': 'STETH', 'STETH': 'STETH',
              'WXDAI': 'DAI', 'XDAI': 'DAI', 'SDAI': 'DAI',
              'USDC.E': 'USDC'
          }

          def normalize(sym):
              return SYMBOL_NORMALIZATION.get(sym.upper(), sym.upper())

          # Process Zerion
          zerion_total = 0
          assets = {}
          dao_gno_qty = 0
          dao_gno_val = 0

          for wallet, positions in zerion_data.items():
              for pos in positions:
                  attrs = pos.get('attributes', {})
                  if attrs.get('fungible_info', {}).get('flags', {}).get('is_trash'):
                      continue
                  name = attrs.get('fungible_info', {}).get('name', '')
                  if '.' in name and ('http' in name or 'www' in name or len(name) > 40):
                      continue

                  symbol = normalize(attrs.get('fungible_info', {}).get('symbol', 'UNKNOWN'))
                  value = attrs.get('value', 0) or 0
                  qty = attrs.get('quantity', {}).get('float', 0) or 0

                  zerion_total += value

                  if symbol not in assets:
                      assets[symbol] = {'quantity': 0, 'value': 0}
                  assets[symbol]['quantity'] += qty
                  assets[symbol]['value'] += value

                  if symbol == 'GNO':
                      dao_gno_qty += qty
                      dao_gno_val += value

          # Process DeBank for total
          debank_total = 0
          RECEIPT_TOKENS = ['steth', 'wsteth', 'reth', 'cbeth', 'frxeth', 'sfrxeth', 'eeth', 'weeth', 'susde', 'usde']

          for wallet, data in debank_data.items():
              for token in data.get('tokens', []):
                  sym = (token.get('symbol') or '').lower()
                  if any(r in sym for r in RECEIPT_TOKENS):
                      continue
                  if token.get('is_verified') == False or not token.get('price'):
                      continue
                  debank_total += (token.get('amount', 0) or 0) * (token.get('price', 0) or 0)

              for protocol in data.get('protocols', []):
                  for item in protocol.get('portfolio_item_list', []):
                      debank_total += item.get('stats', {}).get('net_usd_value', 0) or 0

          # Calculate NAV
          GNO_TOTAL_SUPPLY = 3000000
          ltd_gno = ltd_data.get('gno_balance', 0)
          outstanding_gno = GNO_TOTAL_SUPPLY - dao_gno_qty - ltd_gno
          non_gno_value = zerion_total - dao_gno_val
          nav_per_gno = non_gno_value / outstanding_gno if outstanding_gno > 0 else 0

          summary = {
              'date': TODAY,
              'fetched_at': datetime.utcnow().isoformat() + 'Z',
              'totals': {
                  'zerion': round(zerion_total, 2),
                  'debank': round(debank_total, 2)
              },
              'assets': {k: {'quantity': round(v['quantity'], 4), 'value': round(v['value'], 2)}
                         for k, v in sorted(assets.items(), key=lambda x: -x[1]['value'])[:50]},
              'nav_per_gno': round(nav_per_gno, 2),
              'dao_gno_holdings': round(dao_gno_qty, 2),
              'ltd_gno_balance': round(ltd_gno, 2)
          }

          with open(f'{ARCHIVE_DIR}/summary.json', 'w') as f:
              json.dump(summary, f, indent=2)

          # Update archive index
          index_path = 'archive/index.json'
          if os.path.exists(index_path):
              with open(index_path) as f:
                  index = json.load(f)
          else:
              index = {'snapshots': []}

          # Remove existing entry for today if present
          index['snapshots'] = [s for s in index['snapshots'] if s['date'] != TODAY]

          # Add new entry
          index['snapshots'].append({
              'date': TODAY,
              'zerion_total': round(zerion_total, 2),
              'debank_total': round(debank_total, 2),
              'nav_per_gno': round(nav_per_gno, 2)
          })

          # Sort by date descending
          index['snapshots'].sort(key=lambda x: x['date'], reverse=True)

          # Keep last 365 days
          index['snapshots'] = index['snapshots'][:365]

          with open(index_path, 'w') as f:
              json.dump(index, f, indent=2)

          print(f"Archived snapshot to {ARCHIVE_DIR}/")
          print(f"Zerion total: ${zerion_total:,.2f}")
          print(f"DeBank total: ${debank_total:,.2f}")
          print(f"NAV per GNO: ${nav_per_gno:.2f}")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add *.json archive/
          git diff --staged --quiet || git commit -m "Update treasury data $(date -u +%Y-%m-%d)"
          git push
